<h1>ユーザー一覧</h1>

<%= form_with model: @q, url: admin_users_path, method: :get, local: true, html: { class: "mb-3" } do |f| %>
  <div class="form-row align-items-end">

    <div class="form-group mr-2">
      <%= f.label :profile_name_cont, "名前", class: "mr-2" %>
      <%= f.search_field :profile_name_cont,
      class: "form-control",
      placeholder: "氏名の一部" %>
    </div>

    <div class="form-group mr-2">
      <%= f.label :profile_name_cont, "ステータス", class: "mr-2" %>
      <%= f.search_field :status_cont,
      class: "form-control",
      placeholder: "有効 or 無効" %>
    </div>

    <div class="form-group mr-2">
      <%= f.label :email_cont, "メールアドレス", class: "mr-2" %>
      <%= f.search_field :email_cont,
      class: "form-control",
      placeholder: "メールの一部" %>
    </div>

    <div class="form-group mr-2">
      <%= f.label :family_code_eq, "ファミリーコード", class: "mr-2" %>
      <%= f.search_field :family_code_eq,
      class: "form-control",
      placeholder: "AB12CD34" %>
    </div>

    <div class="form-group mr-2">
      <%= f.label :family_admin_eq, "家族管理者", class: "mr-2" %>
      <%= f.select :family_admin_eq,
            [["すべて", ""], ["管理者のみ", true], ["一般のみ", false]],
            {},
            class: "form-control" %>
    </div>

    <div class="form-group">
      <%= f.submit "検索", class: "btn btn-primary mr-2" %>
      <%= link_to "リセット", admin_users_path, class: "btn btn-outline-secondary" %>
    </div>
  </div>
<% end %>

<%= paginate @users, params: request.query_parameters %>

<p class="text-muted">
  該当 <strong><%= @users.total_count %></strong> 件
</p>

<table class="table table-striped">
  <thead>
    <tr>
      <th>ID</th>
      <th>名前</th>
      <th>ステータス</th>
      <th>メールアドレス</th>
      <th>ファミリーコード</th>
      <th>家族管理者</th>
      <th>登録日</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <% @users.each do |user| %>
      <tr>
        <td><%= user.id %></td>
        <td><%= link_to user.name, admin_user_path(user) %></td>
        <td class="text-center">
          <% if user.active? %>
            <span class="badge badge-success">有効</span>
          <% elsif user.withdrawn? %>
            <span class="badge badge-secondary">退会</span>
          <% else %>
            <span class="badge badge-light"><%= user.status %></span>
          <% end %>
        </td>
        <td><%= user.email %></td>
        <td>
          <% if user.family.present? %>
            <span><%= user.family.code %></span>
          <% else %>
            <span class="text-muted">-</span>
          <% end %>
        </td>
        <td class="text-center">
          <%= user.family_admin? ? content_tag(:span, "家族管理者", class: "badge badge-info") : content_tag(:span, "—", class: "text-muted") %>
        </td>
        
        <td><%= user.created_at.strftime("%Y/%m/%d %H:%M") %></td>
        <td>
          <%= link_to "退会", admin_user_path(user),
          method: :delete,
          data: { confirm: "本当に退会（論理削除）しますか？" },
          class: "btn btn-danger btn-sm" %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>

<%= link_to "← 管理者ホームに戻る", admin_root_path, class: "btn btn-secondary" %>